<div class="mb-4">
  <h1 class="text-primary">
    <%= @table.name.humanize %>
  </h1>

  <% if @table.is_owner?(@current_user) %>
    <div class="d-flex justify-content-end gap-2">
      <%= link_to 'Modifier structure', show_attrs_path(id:@table), title:"Modifier la structure de la table ou des colonnes", class: 'text-end' %> 
      <%= link_to "Partager", partages_path(@table), title:"Voir les utilisateurs qui partagent cette table" %>
      <%= link_to 'Audit', logs_path(id:@table), title:"Audit des modifications" %>
      <%= link_to 'Exporter', export_path(@table), title:"Exporter les données" %>
    </div>
  <% end %>
</div>

<% if @table.fields.any? %>
  <%= form_tag table_path(@table.slug), {method: :get, class: 'd-flex gap-4 mb-4'} do |f| %>
    <div class="d-flex gap-4 flex-wrap mb-4">
      <div>
        <%= label_tag :search, "Rechercher" %>
        <%= text_field_tag :search, params[:search], onchange:'this.form.submit()', class:'form-control' %>
      </div>
      <% @table.fields.filtres.each do | field | %>
        <div>
          <%= label_tag "select[#{field.id}]", field.name.humanize %>
          <% default_value = params.permit![:select] ? params[:select][field.id.to_s] : 'nil' %>
          <%= select_tag "select[#{field.id}]", 
                options_for_select(
                  field.values.records_at(@records).where.not(data: nil).pluck(:data).uniq.sort,
                  default_value), 
                include_blank: true, 
                class: "form-select", 
                onchange: 'this.form.submit()' %>
        </div>
      <% end %>
      <%= link_to "+ Ajouter", fill_url(@table.slug), class: 'btn btn-outline-primary align-self-end' %>
    </div>
  <% end %>

  <div class="overflow-x-auto">
    <table class="table table-striped table-hover sticky">
      <thead>
        <tr style="vertical-align: middle">
          <% @table.fields.each_with_index do | field,index | %>
            <th>
              <%= link_to url_for(params.merge(sort_by: field.id).permit(:id, :sort_by, :search, :select)), class:'text-decoration-none' do %>
                <span class="text-nowrap">
                  <%= field.name.humanize %>
                  <% if params[:sort_by] == field.id.to_s %>
                    <span class="text-decoration-none text-black"><%= (session[:order_by] == 'ASC') ? '△' : '▽' %></span>
                  <% end %>
                </span>
              <% end %>
            </th>
            <% @td_style[index] = @numeric_types.include?(field.datatype) ? 'text-align: right;' : nil %>
          <% end %>
          <th colspan=3></th>
        </tr>
      </thead>

      <% unless @records.size.zero? %>
        <% records_size = 0 %>
        <tbody>
          <% @records.each do | record_index | %>
            <% values = @table.value_datas(record_index) %>
            <% if not values.empty? %>
              <% records_size += 1 %>
              <tr>
                <% @table.fields.each_with_index do | field, index | %>
                  <% if value = values[index]%>
                    <td style="<%= @td_style[index] %>">
                      <% case field.datatype when 'Fichier' %>
                        <%= link_to Blob.find(value).file_attachment.filename, url_for(Blob.find(value).file), target: '_blank' %>
                      <% when 'Image' %>
                        <% if Blob.find(value).file.representable? %>
                          <%= link_to image_tag(Blob.find(value).file.representation(resize_to_limit: [100, 100])), url_for(Blob.find(value).file) %>
                        <% end %>
                      <% when 'Signature' %>
                        <%= link_to("Oui", values_signature_path(table:@table, field:field, record_index:record_index)) %>
                      <% when 'Date' %>
                        <%= l(value.to_date) unless value.blank? %>
                      <% when 'Texte_long' %>
                        <%= truncate(value, length: 80) %>
                      <% when 'Euros' %>
                        <%= number_to_currency(value) %>
                      <% when 'Formule' %>
                        <%= field.evaluate(@table, record_index) %>
                      <% else %>
                        <%= value %>
                      <% end %>

                      <% if field.operation %>
                        <% @sum[field.id] += value.to_f %>
                      <% end %>
                    </td>
                  <% else %>
                    <td></td>
                  <% end %>  
                <% end %>

                <td>
                  <%= link_to "Modifier", fill_url(@table.slug, record_index:record_index), class: 'btn btn-outline-primary btn-sm', 'data-testid': "Modifier ligne n°#{record_index}" %>
                </td>
                <td>
                  <%= link_to "Audit", logs_path(record_index: record_index), class: 'btn btn-outline-info btn-sm', title:"Audit des modifications" %>
                </td>
                <td>
                  <%= link_to "X", delete_record_url(@table.slug, record_index:record_index), data: {'turbo-method': :delete, 'turbo-confirm': 'Confirmez-vous ?'}, class: 'btn btn-outline-danger btn-sm', 'data-testid': "Supprimer ligne n°#{record_index}" %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>

        <tfoot>
          <tr>
            <% @table.fields.each do |field| %>
              <% if field.operation %>
                <td class="text-primary" style="text-align: right">
                  <% if field.Somme? %>
                    <% if field.datatype == "Euros" %>
                      <%= number_to_currency(@sum[field.id]) %>
                    <% else %>
                      <%= number_with_precision(@sum[field.id], precision: 2) %>
                    <% end %>
                  <% elsif field.Moyenne? %>
                    <% if field.datatype == "Euros" %>
                      <%= number_to_currency(@sum[field.id] / @records.count) %>
                    <% else %>
                      <%= number_with_precision(@sum[field.id] / @records.count, precision: 2) %>
                    <% end %>
                  <% end %>
                </td>
              <% else %>
                <td />
              <% end %>
            <% end %>
            <td />
            <td colspan=2></td>
          </tr>
        </tfoot>
      <% end %>
    </table>
    <p>Affichage de <%= records_size %> <%= @table.name %> sur <%= @table.size %> au total <p>
  </div>
<% else %>
  <% unless params[:attrs] %>
    Cette table ne contient aucune colonne<br><br>
    <%= link_to show_attrs_path(id:@table), class: 'btn btn-outline-success' do %>
      Ajouter une colonne
    <% end %> 
  <% end %>
<% end %>
<br><br>
