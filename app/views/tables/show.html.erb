<div class="mb-4">
  <h1 class="text-primary">
    <%= @table.name.humanize.pluralize %>
  </h1>

  <div class="d-flex justify-content-end gap-2">
    <% if policy(@table).show_attrs? %>
      <%= link_to 'Modifier Attributs', show_attrs_path(id:@table), title:"Modifier les attributs de l'Objet '#{@table.name}'" %> 
    <% end %>
    <% if policy(@table).partages? %>
      <%= link_to "Partages", partages_path(@table), title:"Voir les utilisateurs qui partagent l'Objet '#{@table.name}'" %>
    <% end %>
    <% if policy(@table).export? %>
      <%= link_to 'Exporter', export_path(@table), title:"Exporter les donnÃ©es de l'Objet '#{@table.name}'" %>
    <% end %>
    <% if policy(@table).logs? %>
      <%= link_to 'Audit Trail', logs_path(id:@table), title:"Historique des modifications de l'Objet '#{@table.name}'" %>
    <% end %>
  </div>
</div>

<% if @table.fields.any? %>
  <%= form_tag table_path(@table.slug), {method: :get, class: 'd-flex gap-4 mb-4'} do |f| %>
    <div class="d-flex gap-4 flex-wrap mb-4">
      <div>
        <%= label_tag :search, "Rechercher" %>
        <%= text_field_tag :search, params[:search], onchange:'this.form.submit()', class:'form-control' %>
      </div>
      <% @table.fields.filtres.each do | field | %>
        <div>
          <%= label_tag "select[#{field.id}]", field.name.humanize %>
          <% default_value = params.permit![:select] ? params[:select][field.id.to_s] : 'nil' %>
          <% if field.datatype == 'Collection' %>
            <%= select_tag "select[#{field.id}]", 
                  options_for_select(field.populate_linked_table.invert, default_value), 
                  include_blank: true, 
                  class: 'form-select', 
                  onchange: 'this.form.submit()' %> 
          <% else %>
            <%= select_tag "select[#{field.id}]", 
                  options_for_select(field.values.records_at(@records).where.not(data: nil).pluck(:data).uniq.sort, default_value), 
                  include_blank: true, 
                  class: 'form-select', 
                  onchange: 'this.form.submit()' %>
            <% end %>
        </div>
      <% end %>
      <% if policy(@table).fill? %>
        <%= link_to "(+) #{@table.name}", fill_url(@table.slug), class: 'btn btn-outline-primary align-self-end' %>
      <% end %>
    </div>
  <% end %>

  <%= render partial: 'partials/table', locals: {records: @records, table: @table} %>
<% else %>
  <% unless params[:attrs] %>
    Cet objet ne contient aucun attribut pour l'instant<br><br>
    <%= link_to show_attrs_path(id:@table), class: 'btn btn-outline-primary' do %>
      Ajouter un attribut
    <% end %> 
  <% end %>
<% end %>
<br><br>
