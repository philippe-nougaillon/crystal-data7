<div id="details">
  <div class="row row-cols-sm-2 row-cols-lg-3">
    <% @table.fields.détaillable.each_with_index do |field, index| %>
      <% values = @table.value_datas_détaillable(@record_index) %>
      <% value = field.values.find_by(record_index: @record_index) %> 
      <% field_value = value.data if value %>
      <div class="col mb-2">
        <label class="fw-bold">
          <%= field.name.humanize %>
        </label>
        <% if value = values[index]%>
          <div> 
            <% case field.datatype when 'Fichier' %>
              <%= link_to Blob.find(value).file_attachment.filename, url_for(Blob.find(value).file), target: '_blank' %>
            <% when 'Image', 'PDF' %>
              <% blob = Blob.find(value) %>
              <% if blob.file.representable? %>
                <%= link_to url_for(blob.file), {target: "_blank"} do %>
                  <%= image_tag(blob.file.representation(resize_to_limit: [200, 250]), class: 'shadow-lg') %>
                <% end %>
              <% end %>
            <% when 'Signature' %>
              <%= link_to("Oui", values_signature_path(table: @table, field:field, record_index: @record_index)) %>
            <% when 'Date' %>
              <%= l(value.to_date) unless value.blank? %>
            <% when 'Texte_long' %>
              <%= value %>
            <% when 'Texte_riche' %>
              <%= simple_format(value) %>
            <% when 'Euros' %>
              <%= number_to_currency(value) %>
            <% when 'Formule' %>
              <%= field.evaluate(@table, record_index) %>
            <% when 'Workflow' %>
              <% items = field.items_splitted.map{|e| e.split(':')}.to_h %>
              <% color = items[value] %>
              <span class="badge bg-<%= color %>"><%= value %></span>
            <% when 'URL' %>
              <%= link_to URI.parse(value).host, value, target: "_blank" %>
            <% when 'Couleur' %>
              <span style="background-color: <%= value %>">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <% when 'GPS' %>
              <% unless value.blank? %>
                <%= render partial: 'partials/mapbox', locals: {value: value} %>
              <% end %>
            <% when 'Collection' %>
              <% linked_value = field.get_linked_table_record(value.to_i) %>
              <%= link_to linked_value, details_path(Table.find(field.relation.relation_with_id).slug, record_index: value) %>
            <% when 'Utilisateur' %>
              <%= value %>
            <% when 'Vidéo_YouTube' %>
              <iframe width="560" height="315" src="<%= value %>" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            <% else %>
              <%= value %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="text-end text-warning">
    MÀJ le <%= l @table.last_update_at(@record_index) %>
    (il y a <%= time_ago_in_words(@table.last_update_at(@record_index)) %>)
  </div>
</div>