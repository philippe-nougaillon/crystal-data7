<div class="my-4 d-flex align-items-center text-secondary gap-2">
  <h1 class="mb-0">
    Mail Logs
  </h1>
</div>

<p class="text-muted">
  Historique des mails envoyés via 
  <%= link_to "MailGun", "https://www.mailgun.com/fr/", target: "_blank", class: "text-primary hover:underline" %>,
  avec Statut et État (OK = acheminé, OUVERT = vu), visiblent pendant 5 jours.
</p>

<%= form_tag request.path, method: :get do %>
  <div class="row align-items-end">
    <div class="col-sm-4">
      <%= label_tag :to, "Destinataire" %>
      <%= select_tag :to, 
                      options_for_select(@mail_logs.pluck(:to).uniq.sort, params[:to]), 
                      include_blank: true, 
                      class: 'form-select form-select-sm w-100',
                      onchange: 'this.form.submit()' %>
    </div>

    <div class="col-sm-2">
      <%= label_tag :search_subject, "Sujet" %>
      <%= select_tag :search_subject, options_for_select(@mail_logs.pluck(:subject).uniq.sort, params[:search_subject]), include_blank: true, onchange:'this.form.submit()', class:"form-select form-select-sm w-full" %>
    </div>
    <div class="col-sm-3">
      <%= check_box_tag :ko, 1, params[:ko], onchange:'this.form.submit()' %>
      <%= label_tag :ko, "Afficher que les KO ?" %>
    </div>
  </div>
<% end %>

<table class="table mt-4">
  <thead>
    <tr>
      <th>Il y a</th>
      <th>Destinataire</th>
      <th>Sujet</th>
      <th>Statut</th>
      <th>État</th>
      <th></th>
    </tr>
  </thead>

  <tbody>
    <% @mail_logs.each do |mail_log| %>
      <% status_ko = @result_failed["items"].find{|item| item["message"]["headers"]["message-id"] == mail_log.message_id } %>

      <% if params[:ko].blank? || (mail_log.created_at > 5.days.ago && status_ko) %>
        <%= render partial: "mail_log", locals: {mail_log: mail_log, status_ko: status_ko} %>
      <% end %>

    <% end %>
  </tbody>
</table>